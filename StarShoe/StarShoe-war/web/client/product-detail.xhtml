<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:head>
        <title>Product Detail</title>
        <link rel="stylesheet" href="#{request.contextPath}/resources/css/client.css"/>
    </h:head>

    <h:body class="pd-page">

        <ui:include src="/template/client-header.xhtml"/>

        <div class="pd-container">

            <!-- Image -->
            <div class="pd-img-box" style="margin-top: 30px">
                <div class="zoom-lens"></div>
                <div class="zoom-view"></div>
                <img src="#{request.contextPath}/resources/images/products/#{productDetailMB.selectedProduct.image}"
                     class="pd-main-img"/>
            </div>

            <!-- Info -->
            <div class="pd-info">

                <h1 class="pd-title">#{productDetailMB.selectedProduct.productName}</h1>

                <div class="pd-price">
                    <h:panelGroup rendered="#{productDetailMB.selectedProduct.isSale and productDetailMB.selectedProduct.salePercentage gt 0}">
                        <div style="color:#888;font-size:14px;text-decoration:line-through;">
                            <h:outputText value="#{productDetailMB.selectedProduct.price}">
                                <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                            </h:outputText>
                        </div>
                        <div style="color:#d32f2f;font-size:20px;font-weight:800;margin-top:6px;">
                            <h:outputText value="#{productDetailMB.selectedProduct.salePrice}">
                                <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                            </h:outputText>
                        </div>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not (productDetailMB.selectedProduct.isSale and productDetailMB.selectedProduct.salePercentage gt 0)}">
                        <h:outputText value="#{productDetailMB.selectedProduct.price}">
                            <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                        </h:outputText>
                    </h:panelGroup>
                </div>

                <div class="pd-sec">Select Size</div>
                <h:form id="sizeForm">
                    <div class="size-buttons">
                        <ui:repeat value="#{productDetailMB.sizes}" var="s">
                            <h:commandButton value="#{s}"
                                             action="#{productDetailMB.selectSize(s)}"
                                             styleClass="#{productDetailMB.selectedSize eq s ? 'size-btn size-selected' : 'size-btn'}">
                                <f:ajax execute="@this" render="sizeForm"/>
                            </h:commandButton>
                        </ui:repeat>
                    </div>
                </h:form>

                <div class="pd-stock #{productDetailMB.selectedProduct.quantity gt 0 ? 'in' : 'out'}">
                    #{productDetailMB.selectedProduct.quantity gt 0 ? 'In stock' : 'Out of stock'}
                </div>

                <h:form id="productForm">
                    <div class="pd-qty-box">
                        <h:commandButton value="-" action="#{productDetailMB.decreaseQty}">
                            <f:ajax execute="@form" render="@form"/>
                        </h:commandButton>
                        <h:inputText value="#{productDetailMB.quantity}" style="width:40px; text-align:center"/>
                        <h:commandButton value="+" action="#{productDetailMB.increaseQty}">
                            <f:ajax execute="@form" render="@form"/>
                        </h:commandButton>
                    </div>

                    <h:commandButton value="Add to Cart" action="#{productDetailMB.addToCart}" styleClass="btn-cart">
                        <f:ajax execute="@form" render=":cartHeaderForm"/>
                    </h:commandButton>
                    <h:commandButton value="Buy Now" action="#{productDetailMB.buyNow}" styleClass="btn-buy"/>
                </h:form>
                
            </div>
        </div>
        <script>
            function incQty() {
                let i = document.getElementById("qty");
                i.value = parseInt(i.value) + 1;
            }
            function decQty() {
                let i = document.getElementById("qty");
                if (i.value > 1)
                    i.value = parseInt(i.value) - 1;
            }
//<![CDATA[
            const img = document.querySelector(".pd-main-img");
            const lens = document.querySelector(".zoom-lens");
            const zoom = document.querySelector(".zoom-view");

            img.addEventListener("mousemove", zoomMove);
            img.addEventListener("mouseenter", () => {
                lens.style.display = "block";
                zoom.style.display = "block"
            });
            img.addEventListener("mouseleave", () => {
                lens.style.display = "none";
                zoom.style.display = "none"
            });

            function zoomMove(e) {
                let rect = img.getBoundingClientRect();
                let x = e.clientX - rect.left - lens.offsetWidth / 2;
                let y = e.clientY - rect.top - lens.offsetHeight / 2;

                if (x < 0)
                    x = 0;
                if (y < 0)
                    y = 0;
                if (x > img.clientWidth - lens.offsetWidth)
                    x = img.clientWidth - lens.offsetWidth;
                if (y > img.clientHeight - lens.offsetHeight)
                    y = img.clientHeight - lens.offsetHeight;

                lens.style.left = x + "px";
                lens.style.top = y + "px";
                zoom.style.background = "url(" + img.src + ")";
                zoom.style.backgroundSize = (img.width * 2) + "px " + (img.height * 2) + "px";
                zoom.style.backgroundPosition = "-" + (x * 2) + "px -" + (y * 2) + "px";
            }
//]]>
        </script>
        <hr/>
        <!-- TABS -->
        <div class="pd-tabs">

            <div class="tab-buttons">
                <button id="btn-desc" class="active" onclick="showTab('desc')">Description</button>
                <button id="btn-info" onclick="showTab('info')">More Information</button>
                <button id="btn-review" onclick="showTab('review')">
                    Rating (#{productDetailMB.reviews != null ? productDetailMB.reviews.size() : 0})
                </button>
            </div>

            <div id="tab-desc" class="tab-content show">
                <h:outputText value="#{productDetailMB.selectedProduct.description}" escape="false"/>
            </div>

            <div id="tab-info" class="tab-content">
                <p><b>Brand:</b> #{productDetailMB.selectedProduct.brandID.brandName}</p>
                <p><b>Category:</b> #{productDetailMB.selectedProduct.categoryID.categoryName}</p>
                <p><b>Sizes:</b> 36–44</p>
                <p><b>Weight:</b> 1kg</p>
            </div>

            <div id="tab-review" class="tab-content">
                <h:panelGroup id="reviewList">
                    <!-- SHOW Reviews -->
                    <ui:repeat value="#{productDetailMB.reviews}" var="r">
                        <div class="review-block">
                            <div class="review-header">
                                <b>#{r.customerID.fullName}</b>

                                <!-- menu 3 dots -->
                                <h:panelGroup rendered="#{productDetailMB.myReview != null and productDetailMB.myReview.reviewID eq r.reviewID}">
                                    <span class="review-menu" onclick="this.nextElementSibling.classList.toggle('show')">⋮</span>
                                    <div class="review-actions" style="margin-right: 300px">
                                        <h:commandLink value="Edit" action="#{productDetailMB.startEditReview(r)}">
                                            <f:ajax render="reviewForm"/>
                                        </h:commandLink>
                                        <h:commandLink value="Delete" action="#{productDetailMB.deleteReview(r.reviewID)}">
                                            <f:ajax execute="@this" render="@form reviewList"/>
                                        </h:commandLink>


                                    </div>
                                </h:panelGroup>
                            </div>

                            <div class="review-stars-static"><h:outputText value="#{productDetailMB.starsFor(r.rating)}" escape="false"/></div>
                            <div class="review-comment">#{r.comment}</div>
                        </div>
                    </ui:repeat>
                </h:panelGroup>

                <h:panelGroup rendered="#{empty productDetailMB.reviews}">
                    <p style="text-align:center;color:#777;">No reviews yet.</p>
                </h:panelGroup>

                <!-- ADD/EDIT FORM -->
                <h:form id="reviewForm">

                    <h:panelGroup rendered="#{loginMB.loggedUser != null}">

                        <div class="stars-select-wrap">
                            <ui:repeat value="#{[1,2,3,4,5]}" var="i">
                                <h:commandLink action="#{productDetailMB.setNewRating(i)}"
                                               styleClass="star-select #{productDetailMB.newRating ge i ? 'selected' : ''}">
                                    ★
                                    <f:ajax render="@form"/>
                                </h:commandLink>
                            </ui:repeat>
                        </div>

                        <h:inputTextarea value="#{productDetailMB.newComment}" rows="4" styleClass="review-textarea"/>

                        <div style="text-align:center;">
                            <h:commandButton value="#{productDetailMB.editMode ? 'Update Review' : 'Submit Review'}"
                                             action="#{productDetailMB.submitReview}"
                                             styleClass="btn-review-submit">
                                <f:ajax execute="@form" render="@form reviewList"/>
                            </h:commandButton>
                        </div>

                    </h:panelGroup>

                    <h:panelGroup rendered="#{loginMB.loggedUser == null}">
                        <p style="color:#f00;text-align:center;">Please login to review.</p>
                    </h:panelGroup>

                </h:form>
            </div>
        </div>

        <script>
            function showTab(t) {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('show'));
                document.querySelector('#tab-' + t).classList.add('show');
                document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
                document.querySelector('#btn-' + t).classList.add('active');
            }
        </script>

        <!-- Other product -->
        <h3 style="margin-top:40px; margin-left: 150px; font-size: 32pt; font-weight: 800; color: #111">You may also like</h3>

        <h:panelGroup id="productGrid">
            <div class="all-products-grid">
                <ui:repeat value="#{productDetailMB.suggestedProducts}" var="p">
                    <!--                <div class="product-card">-->
                    <a href="/StarShoe-war/client/product-detail.xhtml?id=#{p.productID}" class="product-card fly-up">

                        <div class="product-img-wrap">
                            <img src="#{resource['images/products/' += p.image]}" alt="#{p.productName}" />
                        </div>

                        <div class="product-name">#{p.productName}</div>

                        <div class="product-price">
                            <h:panelGroup rendered="#{p.isSale and p.salePercentage gt 0}">
                                <div style="color:#999;font-size:12px;text-decoration:line-through;"> 
                                    <h:outputText value="#{p.price}">
                                        <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                                    </h:outputText>
                                </div>
                                <div style="color:#d32f2f;font-weight:700;margin-top:4px;">
                                    <h:outputText value="#{p.salePrice}">
                                        <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                                    </h:outputText>
                                </div>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{not (p.isSale and p.salePercentage gt 0)}">
                                <h:outputText value="#{p.price}">
                                    <f:convertNumber type="currency" currencySymbol="$" groupingUsed="true"/>
                                </h:outputText>
                            </h:panelGroup>
                        </div>

                        <div class="stars" >
                            <ui:repeat value="#{[1,2,3,4,5]}" var="i">
                                <h:outputText style="color: gold; font-size:18px;" value="#{i le p.averageRating ? '★' : '☆'}" />
                            </ui:repeat>
                            (#{p.averageRating})
                        </div>
                    </a>
                    <!--                </div>-->
                </ui:repeat>
            </div>
        </h:panelGroup>
        <ui:include src="/template/footer.xhtml" />
    </h:body>
</html>
